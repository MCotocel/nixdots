#!/usr/bin/env bash

dots="$HOME/nixdots/"

if ! type "doas" > /dev/null 2>&1 ; then
  priv="sudo"
else
  priv="doas"
fi

function help() {
    cat <<EOF
Usage: nas [OPTION] [OPTION]

Options:
    help         show this text

    sync         pull config from git repo, then commit and push
    rebuild      rebuild configuration for host
    vm           build a vm
    full         sync and rebuild configuration
    rollback     rollback to previous generation
    update       update flake
    clean        clean and garabge collect store

    search       search packages available
    install      install a package
    uninstall    remove a package
    list         list packages installed
EOF
}

function sync() {
  echo "Syncing nix config"
  cd $dots
  git pull
  git add .
  git diff --cached
  git commit
  git push
}

function rebuild() {
  echo "Rebuilding config"
  $priv nixos-rebuild --flake ~/nixdots --impure switch
}

function vm() {
  echo "Creating VM"
  $priv nixos-rebuild --flake ~/nixdots --impure build-vm
}

function full() {
  nix-sync
  nix-rebuild
}

function rollback() {
  echo "Rolling back"
  $priv nixos-rebuild --rollback switch
}

function update() {
  echo "Updating flake"
  $priv nix flake update /etc/nixos
}

function clean() {
  echo "Cleaning system"
  $priv nix-store --gc
  $priv nix-collect-garbage
  $priv nix-env --delete-generations old
  $priv nix-collect-garbage -d
  nix-collect-garbage -d
}

function search() {
  nix search nixpkgs "${@:3:9999}"
}

function install() {
  nix profile install nixpkgs#$3
}

function uninstall() {
  nix profile remove nixpkgs#$3
}

function list() {
  nix profile list
}

case "$1" in
    nix)
      case "$2" in
        sync)      sync ;;
        rebuild)   rebuild ;;
        vm)        vm ;;
        full)      full ;;
        rollback)  rollback ;;
        update)    update ;;
        clean)     clean ;;
        search)    search $@ ;;
        install)   install $@ ;;
        uninstall) uninstall $@ ;;
        list)      list $@ ;;
        '')      help ;;
        help)    help ;;
        *)       help ;;
      esac ;;
    '')      help ;;
    help)    help ;;
    *)       help ;;
esac
