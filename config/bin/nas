#!/usr/bin/env bash

dots="$HOME/nixdots/"

if ! type "doas" > /dev/null 2>&1 ; then
  priv="sudo"
else
  priv="doas"
fi

function help() {
    cat <<EOF
Usage: nas [OPTION] [OPTION]

Options:
    help         show this text

    clean        clean and garabge collect store
    full         sync and rebuild configuration
    rebuild      rebuild configuration for host
    rollback     rollback to previous generation
    search       search packages available
    sync         pull config from git repo, then commit and push
    update       update flake
    vm           build a vm
EOF
}

function sync() {
  echo "Syncing nix config"
  cd "${dots}" || exit
  git pull
  git add .
  git diff --cached
  git commit
  git push
}

function rebuild() {
  echo "Rebuilding config"
  $priv nixos-rebuild --flake ~/nixdots#"$2" --impure switch
}

function vm() {
  echo "Creating VM"
  $priv nixos-rebuild --flake ~/nixdots#"$2" --impure build-vm
}

function full() {
  nix-sync
  nix-rebuild
}

function rollback() {
  echo "Rolling back"
  $priv nixos-rebuild --rollback switch
}

function update() {
  echo "Updating flake"
  $priv nix flake update ~/nixdots
}

function clean() {
  echo "Clearing store"
  $priv nix-store --gc
  echo "Removing old generations"
  $priv nix-env --delete-generations old
  echo "Collecting system garbage"
  $priv nix-collect-garbage -d
  echo "Collecting user garbage"
  nix-collect-garbage -d
}

function search() {
  nix search nixpkgs "${@:2:9999}"
}

case "$1" in
  sync)      sync ;;
  rebuild)   rebuild "${@}";;
  vm)        vm "${@}" ;;
  full)      full ;;
  rollback)  rollback ;;
  update)    update ;;
  clean)     clean ;;
  search)    search "${@}" ;;
  '')      help ;;
  help)    help ;;
  *)       help ;;
esac
